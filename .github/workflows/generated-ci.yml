name: CI-SistemaGestionApp

on:
  push:
    branches: ["main"]
    tags: ["*"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      # ✅ Repo multi-módulo (padre en raíz, módulo app/)
      - name: Build & Test (Maven)
        run: |
          set -euo pipefail
          mvn -B -f pom.xml -pl app -am test

  sonar:
    runs-on: ubuntu-latest
    needs: build_and_test
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: SonarCloud Analysis (optional)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
        run: |
          set -euo pipefail

          if [ -z "${SONAR_TOKEN:-}" ] || [ -z "${SONAR_PROJECT_KEY:-}" ] || [ -z "${SONAR_ORGANIZATION:-}" ]; then
            echo "Sonar secrets not configured. Skipping Sonar analysis."
            exit 0
          fi

          if [ -z "${SONAR_HOST_URL:-}" ]; then
            SONAR_HOST_URL="https://sonarcloud.io"
          fi

          mvn -B -f pom.xml -pl app -am verify \
            org.sonarsource.scanner.maven:sonar-maven-plugin:3.11.0.3922:sonar \
            -Dsonar.projectKey="${SONAR_PROJECT_KEY}" \
            -Dsonar.organization="${SONAR_ORGANIZATION}" \
            -Dsonar.host.url="${SONAR_HOST_URL}" \
            -Dsonar.login="${SONAR_TOKEN}"

  build_and_push_ecr:
    runs-on: ubuntu-latest
    needs: build_and_test
    # Push a main y tags (NO PR)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Docker image (app/)
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        run: |
          set -euo pipefail

          # Tag = SHA en main, Tag = nombre del tag cuando pusheas un tag (v1.0.0)
          IMAGE_TAG="${GITHUB_SHA}"
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            IMAGE_TAG="${GITHUB_REF#refs/tags/}"
          fi

          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"

          echo "Building image: ${IMAGE_URI}"
          docker build -t "${IMAGE_URI}" -f app/Dockerfile app

          echo "Tagging latest..."
          docker tag "${IMAGE_URI}" "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"

          echo "Pushing images..."
          docker push "${IMAGE_URI}"
          docker push "${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"

          echo "Done ✅"

  deploy_ec2:
    runs-on: ubuntu-latest
    needs: build_and_push_ecr
    # ✅ Deploy SOLO en tags
    if: startsWith(github.ref, 'refs/tags/')

    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}

      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_LLAVE_SSH: ${{ secrets.EC2_LLAVE_SSH }}
      EC2_KNOWN_HOSTS: ${{ secrets.EC2_KNOWN_HOSTS }}

      # ✅ en deploy por tag usa el nombre del tag (v1.0.0)
      IMAGE_TAG: ${{ github.ref_name }}

      APP_PORT: ${{ secrets.APP_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_PORT: ${{ secrets.DB_PORT }}

    steps:
      - uses: actions/checkout@v4

      - name: Preparar clave SSH
        shell: bash
        run: |
          set -e
          mkdir -p ~/.ssh
          printf "%s" "${EC2_LLAVE_SSH}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          if [ -n "${EC2_KNOWN_HOSTS:-}" ]; then
            printf "%s\n" "${EC2_KNOWN_HOSTS}" > ~/.ssh/known_hosts
          else
            ssh-keyscan -H "${EC2_HOST}" >> ~/.ssh/known_hosts
          fi

      - name: Subir docker-compose.yml a EC2
        shell: bash
        run: |
          set -e
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes "${EC2_USER}@${EC2_HOST}" "mkdir -p ~/app"
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes docker-compose.yml "${EC2_USER}@${EC2_HOST}:~/app/docker-compose.yml"

      - name: Deploy en EC2
        shell: bash
        run: |
          set -e

          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes \
            "${EC2_USER}@${EC2_HOST}" \
            "export AWS_REGION='${AWS_REGION}';
             export AWS_ACCOUNT_ID='${AWS_ACCOUNT_ID}';
             export ECR_REPOSITORY='${ECR_REPOSITORY}';
             export IMAGE_TAG='${IMAGE_TAG}';
             export APP_PORT='${APP_PORT}';
             export DB_NAME='${DB_NAME}';
             export DB_USER='${DB_USER}';
             export DB_PASSWORD='${DB_PASSWORD}';
             export DB_PORT='${DB_PORT}';
             bash -se" <<'EOF'
            set -euo pipefail

            clean() { printf '%s' "${1:-}" | tr -d '\r' | tr -d '\n'; }

            cd ~/app

            AWS_REGION_IN="$(clean "${AWS_REGION}")"
            AWS_ACCOUNT_ID_IN="$(clean "${AWS_ACCOUNT_ID}")"
            ECR_REPO_IN="$(clean "${ECR_REPOSITORY}")"
            IMAGE_TAG_IN="$(clean "${IMAGE_TAG}")"

            ECR_REGISTRY="${AWS_ACCOUNT_ID_IN}.dkr.ecr.${AWS_REGION_IN}.amazonaws.com"
            export IMAGE_URI="${ECR_REGISTRY}/${ECR_REPO_IN}:${IMAGE_TAG_IN}"

            export APP_PORT="$(clean "${APP_PORT:-8080}")"
            export DB_NAME="$(clean "${DB_NAME:-sistemagestion}")"
            export DB_USER="$(clean "${DB_USER:-app}")"
            export DB_PASSWORD="$(clean "${DB_PASSWORD:-app}")"
            export DB_PORT="$(clean "${DB_PORT:-5432}")"

            # deps mínimas
            if ! command -v aws >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y awscli
            fi
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y docker.io
              sudo systemctl enable --now docker
            fi
            if ! sudo docker compose version >/dev/null 2>&1; then
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              sudo curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 \
                -o /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
            fi

            # login ECR
            aws ecr get-login-password --region "$AWS_REGION_IN" \
              | sudo -E docker login --username AWS --password-stdin "$ECR_REGISTRY"

            # down / pull / up
            sudo -E docker compose -f docker-compose.yml down --remove-orphans || true
            sudo -E docker compose -f docker-compose.yml pull
            sudo -E docker compose -f docker-compose.yml up -d --remove-orphans

            echo "Estado:"
            sudo docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Ports}}\t{{.Status}}'
          EOF