version: "3.8"

services:
  spring-app:
    # Aquí levanto mi aplicación Spring Boot usando la imagen que me llega por variable.
    image: ${IMAGE_URI}
    container_name: spring-app
    ports:
      # Expongo el puerto 8080 de la app en el 80 de la máquina.
      - "80:8080"
    environment:
      # Configuración genérica de la base de datos. Si no me llegan variables
      # desde fuera, uso estos valores por defecto.
      DB_ENGINE: ${DB_ENGINE:-postgresql}
      DB_HOST: ${DB_HOST:-postgres-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-tfg}
      DB_USER: ${DB_USER:-tfg}
      DB_PASSWORD: ${DB_PASSWORD:-tfg}

      # Propiedades que espera Spring para conectarse a la BD.
      SPRING_DATASOURCE_URL: "jdbc:${DB_ENGINE}://${DB_HOST}:${DB_PORT}/${DB_NAME}"
      SPRING_DATASOURCE_USERNAME: ${DB_USER}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

    # La app depende de que la base de datos esté levantada.
    depends_on:
      - postgres-db

  # Servicio de PostgreSQL que uso como BD local o en la EC2.
  postgres-db:
    image: postgres:15
    container_name: postgres-db
    environment:
      # Aquí reutilizo las mismas variables para que todo quede alineado.
      POSTGRES_DB: ${DB_NAME:-tfg}
      POSTGRES_USER: ${DB_USER:-tfg}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-tfg}
    ports:
      # Expongo el puerto de PostgreSQL para poder conectarme desde fuera si lo necesito.
      - "5432:5432"
    volumes:
      # Volumen para persistir los datos de la base de datos.
      - postgres-data:/var/lib/postgresql/data

volumes:
  # Volumen nombrado donde se guardan los datos de PostgreSQL.
  postgres-data: