<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>Mapa - Google Maps</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    #map {
      height: 500px;
      width: 100%;
    }
  </style>
</head>
<body class="container mt-5">

<h2 class="text-center mb-4">📍 Mapa de la Universidad de Burgos</h2>

<nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">📦 Sistema Gestión</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="/">Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="/usuarios">Usuarios</a></li>
        <li class="nav-item"><a class="nav-link" href="/productos">Productos</a></li>
        <li class="nav-item"><a class="nav-link" href="/blockchain">Blockchain</a></li>
        <li class="nav-item"><a class="nav-link" href="/mapa">Mapa</a></li>
        <li class="nav-item"><a class="nav-link" href="/chat">Chat</a></li>
      </ul>
      <div class="ms-auto">
        <span sec:authorize="isAuthenticated()">
          <a href="/logout" class="btn btn-outline-danger btn-sm">Cerrar sesión</a>
        </span>
        <span sec:authorize="isAnonymous()">
          <a href="/login" class="btn btn-outline-primary btn-sm">Login</a>
        </span>
      </div>
    </div>
  </div>
</nav>

<!-- Campo de búsqueda -->
<div class="mb-4" style="z-index: 1; position: relative;">
  <label for="busqueda" class="form-label">🔍 ¿Qué quieres buscar cerca de la UBU?</label>
  <div class="input-group">
    <input type="text" id="busqueda" class="form-control" placeholder="Ej: cafeterías, farmacias, gasolineras...">
    <button class="btn btn-primary" onclick="buscar()">Buscar</button>
  </div>
</div>

<!-- Mapa -->
<div id="map" class="shadow-sm border"></div>

<script>
  let map;
  let service;
  let infowindow;
  const ubiUBU = { lat: 42.343992, lng: -3.696906 };

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 16,
      center: ubiUBU,
    });

    infowindow = new google.maps.InfoWindow();

    new google.maps.Marker({
      position: ubiUBU,
      map: map,
      title: "Universidad de Burgos",
    });
  }

  function buscar() {
    const texto = document.getElementById("busqueda").value;
    if (!texto.trim()) return;

    const request = {
      location: ubiUBU,
      radius: 1000, // en metros
      query: texto
    };

    service = new google.maps.places.PlacesService(map);
    service.textSearch(request, (resultados, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK) {
        resultados.forEach(lugar => {
          const marker = new google.maps.Marker({
            map,
            position: lugar.geometry.location,
            title: lugar.name
          });

          marker.addListener("click", () => {
            infowindow.setContent(lugar.name);
            infowindow.open(map, marker);
          });
        });

        map.setCenter(resultados[0].geometry.location);
      } else {
        alert("❌ No se encontraron resultados para: " + texto);
      }
    });
  }
</script>

<!-- Incluye la API de Google Maps con Places -->
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvu1IRidMnjKTlDLPQFrwFuZLtDftYxUE&libraries=places&callback=initMap">
</script>

</body>
</html>