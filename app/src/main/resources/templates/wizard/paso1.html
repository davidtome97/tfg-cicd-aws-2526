<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Paso 1 – Configuración de SonarCloud</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <!-- appId disponible en JS -->
    <meta name="appId" th:content="${appId}">
</head>

<body class="bg-light">

<div class="container mt-3">
    <div class="d-flex justify-content-end mb-3">
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn btn-outline-danger">
                Cerrar sesión
            </button>
        </form>
    </div>
</div>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/aplicaciones}">Sistema CI/CD – Paso 1</a>
    </div>
</nav>

<div class="container">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Paso 1 – Configuración de SonarCloud</h2>

        <a href="/manuales/paso_1.pdf" target="_blank"
           class="btn btn-outline-secondary btn-sm">
            Ver guía de este paso
        </a>
    </div>

    <p class="text-muted">
        En este paso se valida la conexión con SonarCloud. El asistente asume la URL
        <code>https://sonarcloud.io</code> y obtiene la organización a partir de la clave de proyecto,
        por lo que únicamente es necesario introducir el <strong>projectKey</strong> y el
        <strong>token</strong> de SonarCloud.
    </p>

    <div class="card p-4 shadow-sm">
        <div class="mb-3">
            <label class="form-label">ProjectKey (SONAR_PROJECT_KEY)</label>
            <input id="projectKey" class="form-control"
                   placeholder="Ej: mi-organizacion_mi-proyecto">
            <div class="form-text">
                Debe corresponder con la clave de proyecto configurada en SonarCloud.
                La organización se extraerá automáticamente a partir de este valor.
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Token SonarCloud (SONAR_TOKEN)</label>
            <input id="token" class="form-control" placeholder="Token SonarCloud">
            <div class="form-text">
                Token personal generado en SonarCloud. No debe almacenarse en el repositorio,
                solo en variables secretas.
            </div>
        </div>

        <button type="button" onclick="ejecutarPaso1()" class="btn btn-primary">
            Comprobar
        </button>

        <hr>

        <!-- ESTADO inicial desde BD (controlPaso) -->
        <p class="mt-3 fs-5">
            Estado:
            <span id="estado"
                  class="badge bg-secondary"
                  th:text="${controlPaso != null ? controlPaso.estado : 'PENDIENTE'}">
                PENDIENTE
            </span>
        </p>

        <p id="mensaje" class="text-muted mb-0"
           th:text="${controlPaso != null ? controlPaso.mensaje : ''}"></p>
    </div>

    <div class="mt-3 d-flex justify-content-between">
        <a th:href="@{/aplicaciones}" class="btn btn-link">&larr; Volver al listado</a>
        <a th:href="@{/wizard/paso2(appId=${appId})}" class="btn btn-link">Ir al paso 2 →</a>
    </div>

</div>

<script>
    function getAppId() {
        const meta = document.querySelector('meta[name="appId"]');
        const appId = meta ? meta.getAttribute("content") : null;
        if (!appId) {
            alert("Falta appId. Vuelve al listado y entra al asistente desde una aplicación.");
            throw new Error("appId missing");
        }
        return appId;
    }

    function setEstadoUI(estado, mensaje) {
        const badge = document.getElementById("estado");
        const msg = document.getElementById("mensaje");

        badge.innerText = estado || "N/A";
        msg.innerText = mensaje || "";

        if (estado === "OK") badge.className = "badge bg-success";
        else if (estado === "KO") badge.className = "badge bg-danger";
        else badge.className = "badge bg-secondary";
    }

    // Pintar color al cargar (según lo que venga de BD)
    (function pintarEstadoInicial(){
        const badge = document.getElementById("estado");
        if (!badge) return;
        const estado = (badge.textContent || "").trim();

        if (estado === "OK") badge.className = "badge bg-success";
        else if (estado === "KO") badge.className = "badge bg-danger";
        else badge.className = "badge bg-secondary";
    })();

    async function ejecutarPaso1() {
        const appId = getAppId();
        const token = document.getElementById("token").value || "";
        const projectKey = document.getElementById("projectKey").value || "";

        try {
            setEstadoUI("PENDIENTE", "Ejecutando comprobación...");

            const url = `/api/wizard/paso1?appId=${encodeURIComponent(appId)}`
                + `&token=${encodeURIComponent(token)}`
                + `&projectKey=${encodeURIComponent(projectKey)}`;

            const res = await fetch(url);
            if (!res.ok) throw new Error("HTTP " + res.status);

            const data = await res.json();
            setEstadoUI(data.estado, data.mensaje);

        } catch (e) {
            setEstadoUI("KO", "Error llamando al backend en el paso 1.");
        }
    }
</script>

</body>
</html>