<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<div class="d-flex justify-content-end mb-3">
    <form th:action="@{/logout}" method="post">
        <button type="submit" class="btn btn-outline-danger">
            Cerrar sesión
        </button>
    </form>
</div>
<head>
    <meta charset="UTF-8">
    <title>Paso 1 – Configuración de SonarCloud</title>

    <!-- Bootstrap para estilos -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>

<body class="bg-light">

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Sistema CI/CD – Paso 1</a>
    </div>
</nav>

<div class="container">

    <!-- Cabecera + botón ayuda -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Paso 1 – Configuración de SonarCloud</h2>

        <!-- Botón "Ver guía de este paso" -->
        <a href="/manuales/paso1-sonarcloud.pdf" target="_blank"
           class="btn btn-outline-secondary btn-sm">
            Ver guía de este paso
        </a>
    </div>

    <p class="text-muted">
        En este paso se valida la conexión con SonarCloud. El asistente asume la URL
        <code>https://sonarcloud.io</code> y obtiene la organización a partir de la clave de proyecto,
        por lo que únicamente es necesario introducir el <strong>projectKey</strong> y el
        <strong>token</strong> de SonarCloud.
    </p>

    <!-- FORM -->
    <div class="card p-4 shadow-sm">
        <div class="mb-3">
            <label class="form-label">ProjectKey (SONAR_PROJECT_KEY)</label>
            <input id="projectKey" class="form-control"
                   placeholder="Ej: mi-organizacion_mi-proyecto">
            <div class="form-text">
                Debe corresponder con la clave de proyecto configurada en SonarCloud.
                La organización se extraerá automáticamente a partir de este valor.
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Token SonarCloud (SONAR_TOKEN)</label>
            <input id="token" class="form-control" placeholder="Token SonarCloud">
            <div class="form-text">
                Token personal generado en SonarCloud. No debe almacenarse en el repositorio,
                solo en variables secretas.
            </div>
        </div>

        <button onclick="ejecutarPaso1()" class="btn btn-primary">Comprobar</button>

        <hr>

        <!-- ESTADO -->
        <p class="mt-3 fs-5">
            Estado: <span id="estado" class="badge bg-secondary">PENDIENTE</span>
        </p>
        <p id="mensaje" class="text-muted"></p>
    </div>

    <a href="/wizard/paso2" class="btn btn-link mt-3">Ir al paso 2 →</a>

</div>


<!-- SCRIPT -->
<script>
    function ejecutarPaso1() {
        const token = document.getElementById("token").value;
        const projectKey = document.getElementById("projectKey").value;

        fetch(`/api/wizard/paso1?token=${encodeURIComponent(token)}&projectKey=${encodeURIComponent(projectKey)}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("estado").innerText = data.estado;
                document.getElementById("mensaje").innerText = data.mensaje;

                if (data.estado === "OK") {
                    document.getElementById("estado").className = "badge bg-success";
                } else {
                    document.getElementById("estado").className = "badge bg-danger";
                }

                sessionStorage.setItem(
                    "wizard_paso1",
                    JSON.stringify({ estado: data.estado, mensaje: data.mensaje })
                );
            })
            .catch(err => {
                document.getElementById("estado").innerText = "KO";
                document.getElementById("estado").className = "badge bg-danger";
                document.getElementById("mensaje").innerText = "Error llamando al backend en el paso 1.";

                sessionStorage.setItem(
                    "wizard_paso1",
                    JSON.stringify({ estado: "KO", mensaje: "Error llamando al backend en el paso 1." })
                );
            });
    }
</script>

</body>
</html>