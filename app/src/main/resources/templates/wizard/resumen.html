<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Resumen del asistente CI/CD</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <meta name="appId" th:content="${appId}">
</head>

<body class="bg-light">

<div class="container mt-3">
    <div class="d-flex justify-content-end mb-3">
        <form th:action="@{/logout}" method="post" class="m-0">
            <button type="submit" class="btn btn-outline-danger btn-sm">
                Cerrar sesi√≥n
            </button>
        </form>
    </div>
</div>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/aplicaciones}">
            Sistema CI/CD ‚Äì Resumen
        </a>
    </div>
</nav>

<div class="container" style="margin-bottom: 70px;">

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
        <div>
            <h2 class="mb-0">Resumen de comprobaciones</h2>
            <div class="text-muted">
                Aqu√≠ tienes el estado de cada paso. Descarga el TXT con las variables para tu CI/CD.
            </div>
        </div>

        <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-outline-secondary"
               th:href="@{/wizard/resumen/variables-txt(appId=${appId})}">
                ‚¨áÔ∏è Descargar variables (.txt)
            </a>

            <button class="btn btn-secondary" type="button" onclick="exportarPdfDesdeDom()">
                üìÑ Exportar resumen en PDF
            </button>
        </div>
    </div>

    <p class="text-muted">
        Si alg√∫n paso aparece en rojo (<span class="badge bg-danger">KO</span>),
        vuelve al paso correspondiente y corrige la configuraci√≥n.
    </p>

    <!-- PROGRESO GLOBAL -->
    <div class="card shadow-sm mb-4">
        <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div>
                <div class="fw-semibold">Progreso</div>
                <div class="text-muted" id="txtProgreso">Calculando‚Ä¶</div>
            </div>

            <div class="flex-grow-1" style="min-width: 220px;">
                <div class="progress" role="progressbar" aria-label="Progreso asistente">
                    <div id="barProgreso" class="progress-bar" style="width: 0%"></div>
                </div>
            </div>

            <span id="badgeGlobal" class="badge bg-secondary">N/A</span>
        </div>
    </div>

    <!-- RESULTADOS -->
    <div class="card p-4 shadow-sm mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Resultados</h4>
            <small class="text-muted">Paso 0 ‚Üí Paso 6</small>
        </div>

        <ul class="list-group" id="listaPasos">
            <li class="list-group-item"
                th:each="p : ${pasos}"
                th:attr="data-numero=${p.numero},data-estado=${p.estado}">
                <div class="d-flex justify-content-between align-items-center">
                    <strong th:text="${'Paso ' + p.numero + ' ‚Äì ' + p.titulo}">
                        Paso X
                    </strong>

                    <span class="badge"
                          th:text="${p.estado}"
                          th:classappend="${p.estado == 'OK'} ? ' bg-success'
                              : (${p.estado == 'KO'} ? ' bg-danger' : ' bg-secondary')">
                        N/A
                    </span>
                </div>

                <small class="text-muted d-block mt-1" th:text="${p.mensaje}"></small>
            </li>
        </ul>
    </div>

    <!-- INTERPRETACI√ìN -->
    <div class="card p-4 shadow-sm mb-4">
        <h4 class="mb-3">Interpretaci√≥n del resultado</h4>

        <ul class="mb-2">
            <li><span id="interp0">Paso 0 ‚Üí pendiente‚Ä¶</span></li>
            <li><span id="interp12">Pasos 1 y 2 ‚Üí pendiente‚Ä¶</span></li>
            <li><span id="interp3">Paso 3 ‚Üí pendiente‚Ä¶</span></li>
            <li><span id="interp4">Paso 4 ‚Üí pendiente‚Ä¶</span></li>
            <li><span id="interp5">Paso 5 ‚Üí pendiente‚Ä¶</span></li>
            <li><span id="interp6">Paso 6 ‚Üí pendiente‚Ä¶</span></li>
        </ul>

        <p class="text-muted mb-0">
            Si alg√∫n paso est√° en KO, vuelve atr√°s y corrige la configuraci√≥n correspondiente.
        </p>
    </div>

    <!-- NAVEGACI√ìN -->
    <div class="mt-4 d-flex justify-content-between align-items-start flex-nowrap gap-3">
        <a th:href="@{/wizard/paso6(appId=${appId})}"
           class="btn btn-outline-secondary">
            ‚Üê Volver al paso 6
        </a>

        <a th:href="@{/aplicaciones}"
           class="btn btn-outline-secondary">
            Volver al listado
        </a>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
    function getAppId() {
        const meta = document.querySelector('meta[name="appId"]');
        return meta ? meta.getAttribute("content") : "";
    }

    function estadoPaso(n) {
        const li = document.querySelector(`#listaPasos li[data-numero="${n}"]`);
        return (li?.getAttribute("data-estado") || "N/A").trim();
    }

    function calcularProgreso() {
        const items = Array.from(document.querySelectorAll("#listaPasos li[data-estado]"));
        const total = items.length || 1;
        const ok = items.filter(li => (li.getAttribute("data-estado") || "").trim() === "OK").length;
        const ko = items.filter(li => (li.getAttribute("data-estado") || "").trim() === "KO").length;

        const pct = Math.round((ok / total) * 100);

        const bar = document.getElementById("barProgreso");
        const txt = document.getElementById("txtProgreso");
        const badge = document.getElementById("badgeGlobal");

        if (bar) bar.style.width = pct + "%";
        if (txt) txt.textContent = `${ok}/${total} pasos en OK (${pct}%).`;

        if (badge) {
            if (ok === total) {
                badge.className = "badge bg-success";
                badge.textContent = "COMPLETADO";
            } else if (ko > 0) {
                badge.className = "badge bg-danger";
                badge.textContent = "REVISAR";
            } else {
                badge.className = "badge bg-secondary";
                badge.textContent = "EN PROGRESO";
            }
        }
    }

    function pintarInterpretacion() {
        const p0 = estadoPaso(0);
        const p1 = estadoPaso(1);
        const p2 = estadoPaso(2);
        const p3 = estadoPaso(3);
        const p4 = estadoPaso(4);
        const p5 = estadoPaso(5);
        const p6 = estadoPaso(6);

        const i0  = document.getElementById("interp0");
        const i12 = document.getElementById("interp12");
        const i3  = document.getElementById("interp3");
        const i4  = document.getElementById("interp4");
        const i5  = document.getElementById("interp5");
        const i6  = document.getElementById("interp6");

        i0.textContent =
            p0 === "OK" ? "Paso 0 OK ‚Üí Repositorio inicializado y primer commit realizado."
                : p0 === "KO" ? "Paso 0 KO ‚Üí No se ha podido verificar el primer commit."
                    : "Paso 0 a√∫n no se ha ejecutado.";

        i12.textContent =
            (p1 === "OK" && p2 === "OK")
                ? "Pasos 1 y 2 OK ‚Üí Integraci√≥n Git ‚Üî SonarCloud correcta."
                : (p1 === "KO" || p2 === "KO")
                    ? "Pasos 1 y/o 2 KO ‚Üí Token, ProjectKey o an√°lisis incorrectos."
                    : "Pasos 1 y 2 a√∫n no se han ejecutado.";

        i3.textContent =
            p3 === "OK" ? "Paso 3 OK ‚Üí Repositorio Git accesible."
                : p3 === "KO" ? "Paso 3 KO ‚Üí El repositorio no existe o no tiene commits."
                    : "Paso 3 a√∫n no se ha ejecutado.";

        i4.textContent =
            p4 === "OK" ? "Paso 4 OK ‚Üí Imagen Docker encontrada en ECR."
                : p4 === "KO" ? "Paso 4 KO ‚Üí No se encontr√≥ la imagen Docker en ECR."
                    : "Paso 4 a√∫n no se ha ejecutado.";

        i5.textContent =
            p5 === "OK" ? "Paso 5 OK ‚Üí Configuraci√≥n de base de datos completada."
                : p5 === "KO" ? "Paso 5 KO ‚Üí Error en la configuraci√≥n o generaci√≥n de BD."
                    : "Paso 5 a√∫n no se ha ejecutado.";

        i6.textContent =
            p6 === "OK" ? "Paso 6 OK ‚Üí Variables EC2 listas."
                : p6 === "KO" ? "Paso 6 KO ‚Üí EC2 no responde o faltan variables (IP/puerto/ssh)."
                    : "Paso 6 a√∫n no se ha ejecutado.";
    }

    async function exportarPdfDesdeDom() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const items = Array.from(document.querySelectorAll("#listaPasos .list-group-item"));
        let y = 20;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("Informe de comprobaciones CI/CD", 14, y);
        y += 10;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        doc.text("Fecha: " + new Date().toLocaleString(), 14, y);
        y += 6;

        const appId = getAppId();
        if (appId) {
            doc.text("appId: " + appId, 14, y);
            y += 10;
        } else {
            y += 8;
        }

        items.forEach(li => {
            if (y > 260) { doc.addPage(); y = 20; }

            const titulo = (li.querySelector("strong")?.textContent || "Paso").trim();
            const estado = (li.querySelector(".badge")?.textContent || "N/A").trim();
            const mensaje = (li.querySelector("small")?.textContent || "Sin mensaje.").trim();

            doc.setFont("helvetica", "bold");
            doc.setFontSize(13);
            doc.text(titulo, 14, y);
            y += 6;

            doc.setFont("helvetica", "normal");
            doc.setFontSize(11);
            doc.text("Estado: " + estado, 14, y);
            y += 5;

            const lines = doc.splitTextToSize(mensaje, 180);
            doc.text(lines, 14, y);
            y += lines.length * 5 + 6;
        });

        doc.save("resumen_cicd.pdf");
    }

    document.addEventListener("DOMContentLoaded", () => {
        calcularProgreso();
        pintarInterpretacion();
    });
</script>

</body>
</html>