<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Resumen del asistente CI/CD</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>

<body class="bg-light">

<div class="container mt-3">
    <div class="d-flex justify-content-end mb-3">
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn btn-outline-danger">Cerrar sesiÃ³n</button>
        </form>
    </div>
</div>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/aplicaciones}">Sistema CI/CD â€“ Resumen</a>
    </div>
</nav>

<div class="container">

    <h2 class="mb-3">Resumen de comprobaciones</h2>

    <p class="text-muted">
        Este resumen recoge los resultados obtenidos en cada paso del asistente.
        Si algÃºn paso aparece en rojo (<span class="badge bg-danger">KO</span>),
        puedes volver atrÃ¡s para revisarlo.
    </p>

    <div class="mb-3">
        <button class="btn btn-secondary" type="button" onclick="exportarPdfDesdeDom()">
            ðŸ“„ Exportar resumen en PDF
        </button>
    </div>

    <div class="card p-4 shadow-sm mb-4">
        <h4 class="mb-3">Resultados</h4>

        <ul class="list-group" id="listaPasos">
            <li class="list-group-item"
                th:each="p : ${pasos}"
                th:attr="data-numero=${p.numero},data-estado=${p.estado}">
                <div class="d-flex justify-content-between align-items-center">
                    <strong th:text="${'Paso ' + p.numero + ' â€“ ' + p.titulo + ':'}">Paso X</strong>

                    <span class="badge"
                          th:text="${p.estado}"
                          th:classappend="${p.estado == 'OK'} ? ' bg-success' :
                                (${p.estado == 'KO'} ? ' bg-danger' : ' bg-secondary')">
                        N/A
                    </span>
                </div>

                <small class="text-muted" th:text="${p.mensaje}"></small>
            </li>
        </ul>
    </div>

    <div class="card p-4 shadow-sm">
        <h4 class="mb-3">InterpretaciÃ³n del resultado</h4>

        <ul class="mb-2">
            <li><span id="interp0">Paso 0 â†’ pendiente...</span></li>
            <li><span id="interp12">Pasos 1 y 2 â†’ pendiente...</span></li>
            <li><span id="interp3">Paso 3 â†’ pendiente...</span></li>
            <li><span id="interp4">Paso 4 â†’ pendiente...</span></li>
            <li><span id="interp5">Paso 5 â†’ pendiente...</span></li>
            <li><span id="interp6">Paso 6 â†’ pendiente...</span></li>
            <li><span id="interp7">Paso 7 â†’ pendiente...</span></li>
        </ul>

        <p class="text-muted mb-0">
            Si algÃºn paso estÃ¡ en KO, vuelve atrÃ¡s y corrige los parÃ¡metros o configuraciÃ³n afectados.
        </p>
    </div>

    <div class="mt-3 d-flex justify-content-between">
        <!-- Mejor que volver al paso 6: vuelve al asistente (entry) y te lleva al paso correcto -->
        <a th:href="@{/wizard/paso6(appId=${appId})}" class="btn btn-link">&larr; Volver al paso 6</a>
        <a th:href="@{/aplicaciones}" class="btn btn-primary">Volver al listado</a>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
    function estadoPaso(n) {
        const li = document.querySelector(`#listaPasos li[data-numero="${n}"]`);
        return (li?.getAttribute("data-estado") || "N/A").trim();
    }

    function pintarInterpretacion() {
        const p0 = estadoPaso(0);
        const p1 = estadoPaso(1), p2 = estadoPaso(2), p3 = estadoPaso(3), p4 = estadoPaso(4), p5 = estadoPaso(5);
        const p6 = estadoPaso(6);
        const p7 = estadoPaso(7);

        const i0  = document.getElementById("interp0");
        const i12 = document.getElementById("interp12");
        const i3  = document.getElementById("interp3");
        const i4  = document.getElementById("interp4");
        const i5  = document.getElementById("interp5");
        const i6  = document.getElementById("interp6");
        const i7  = document.getElementById("interp7");

        // Paso 0
        if (p0 === "OK") i0.textContent = "Paso 0 OK â†’ Repositorio inicializado y primer commit realizado.";
        else if (p0 === "KO") i0.textContent = "Paso 0 KO â†’ No se ha podido verificar el primer commit.";
        else i0.textContent = "Paso 0 aÃºn no se ha ejecutado.";

        // Pasos 1 y 2
        if (p1 === "OK" && p2 === "OK") i12.textContent = "Pasos 1 y 2 OK â†’ IntegraciÃ³n Git â†” SonarCloud correcta.";
        else if (p1 === "KO" || p2 === "KO") i12.textContent = "Pasos 1 y/o 2 KO â†’ Token/ProjectKey incorrectos o Sonar no recibe anÃ¡lisis.";
        else i12.textContent = "Pasos 1 y 2 aÃºn no se han ejecutado.";

        // Paso 3
        if (p3 === "OK") i3.textContent = "Paso 3 OK â†’ Repositorio Git accesible.";
        else if (p3 === "KO") i3.textContent = "Paso 3 KO â†’ El repositorio no existe o no tiene commits.";
        else i3.textContent = "Paso 3 aÃºn no se ha ejecutado.";

        // Paso 4
        if (p4 === "OK") i4.textContent = "Paso 4 OK â†’ Imagen Docker encontrada en ECR.";
        else if (p4 === "KO") i4.textContent = "Paso 4 KO â†’ No se encontrÃ³ la imagen Docker en ECR.";
        else i4.textContent = "Paso 4 aÃºn no se ha ejecutado.";

        // Paso 5
        if (p5 === "OK") i5.textContent = "Paso 5 OK â†’ La aplicaciÃ³n responde correctamente en EC2.";
        else if (p5 === "KO") i5.textContent = "Paso 5 KO â†’ EC2 no responde (IP/puerto/reglas/despliegue).";
        else i5.textContent = "Paso 5 aÃºn no se ha ejecutado.";

        // Paso 6
        if (p6 === "OK") i6.textContent = "Paso 6 OK â†’ GuÃ­a de base de datos (PDF) descargada y variables definidas.";
        else if (p6 === "KO") i6.textContent = "Paso 6 KO â†’ Fallo al generar/descargar el PDF o configuraciÃ³n incompleta.";
        else i6.textContent = "Paso 6 aÃºn no se ha ejecutado.";

        // Paso 7
        if (p7 === "OK") i7.textContent = "Paso 7 OK â†’ Todos los pasos completados correctamente.";
        else if (p7 === "KO") i7.textContent = "Paso 7 KO â†’ Hay pasos previos en KO o pendientes.";
        else i7.textContent = "Paso 7 aÃºn no se ha ejecutado.";
    }

    document.addEventListener("DOMContentLoaded", pintarInterpretacion);

    async function exportarPdfDesdeDom() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const items = Array.from(document.querySelectorAll("#listaPasos .list-group-item"));
        let y = 20;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("Informe de comprobaciones CI/CD", 14, y);
        y += 10;

        const fecha = new Date().toLocaleString();
        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        doc.text("Fecha: " + fecha, 14, y);
        y += 12;

        items.forEach(li => {
            if (y > 260) { doc.addPage(); y = 20; }

            const titulo = (li.querySelector("strong")?.textContent || "Paso").trim();
            const estado = (li.querySelector(".badge")?.textContent || "N/A").trim();
            const mensaje = (li.querySelector("small")?.textContent || "Sin mensaje.").trim();

            doc.setFont("helvetica", "bold");
            doc.setFontSize(13);
            doc.text(titulo, 14, y);
            y += 6;

            doc.setFont("helvetica", "normal");
            doc.setFontSize(11);
            doc.text("Estado: " + estado, 14, y);
            y += 5;

            const lineas = doc.splitTextToSize(mensaje, 180);
            doc.text(lineas, 14, y);
            y += lineas.length * 5 + 6;
        });

        doc.save("resumen_cicd.pdf");
    }
</script>

</body>
</html>