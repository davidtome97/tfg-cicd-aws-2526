<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:margin-bottom="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Paso 4 ‚Äì Comprobar imagen en ECR</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <!-- ‚úÖ IntroJS (tutorial guiado) -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/intro.js/minified/introjs.min.css">

    <meta name="appId" th:content="${appId}">
</head>

<body class="bg-light">

<div class="container mt-3">
    <div class="d-flex justify-content-end mb-3">
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn btn-outline-danger">
                Cerrar sesi√≥n
            </button>
        </form>
    </div>
</div>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/aplicaciones}">
            Sistema CI/CD ‚Äì Paso 4
        </a>
    </div>
</nav>

<div class="container" id="tutorial_root" style="margin-bottom: 70px;">

    <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="mb-0">Paso 4 ‚Äì Configurar variables AWS + comprobar imagen en ECR</h2>

        <div class="d-flex gap-2">
            <a id="btnGuiaPaso"
               href="/manuales/paso_4.pdf"
               target="_blank"
               class="btn btn-outline-secondary btn-sm">
                üìò Ver gu√≠a de este paso
            </a>

            <button id="inicio_tutorial"
                    type="button"
                    class="btn btn-outline-secondary btn-sm">
                Iniciar tutorial
            </button>
        </div>
    </div>

    <p class="text-muted" id="intro_texto">
        En este paso introduces las variables necesarias para acceder a AWS/ECR y se comprueba
        que existe una imagen Docker en Amazon ECR con el repositorio y tag indicados.
        Si todo sale OK, al final ver√°s las variables para copiarlas como <b>Secrets</b>.
    </p>

    <div class="card p-4 shadow-sm" id="card_paso4">

        <!-- =========================
             ‚úÖ VARIABLES AWS (SECRETS)
             ========================= -->

        <h5 class="mb-3">Variables para crear como Secrets</h5>

        <div class="mb-3" id="ecr_repo_container">
            <label class="form-label">ECR_REPOSITORY</label>
            <input id="ecrRepository"
                   class="form-control"
                   placeholder="Ej: tfg-cicd-aws-2526"
                   th:value="${ecrRepository}">
            <div class="form-text">
                Nombre del repositorio en ECR (sin URL).
            </div>
        </div>

        <div class="mb-3" id="aws_region_container">
            <label class="form-label">AWS_REGION</label>
            <input id="awsRegion"
                   class="form-control"
                   placeholder="Ej: eu-west-1"
                   th:value="${awsRegion}">
            <div class="form-text">
                Regi√≥n donde est√° tu ECR (por ejemplo: eu-west-1).
            </div>
        </div>

        <div class="mb-3" id="aws_account_container">
            <label class="form-label">AWS_ACCOUNT_ID</label>
            <input id="awsAccountId"
                   class="form-control"
                   placeholder="Ej: 123456789012"
                   th:value="${awsAccountId}">
            <div class="form-text">
                ID de cuenta AWS (12 d√≠gitos).
            </div>
        </div>

        <div class="mb-3" id="aws_access_container">
            <label class="form-label">AWS_ACCESS_KEY_ID</label>
            <input id="awsAccessKeyId"
                   class="form-control"
                   placeholder="Ej: AKIA..."
                   th:value="${awsAccessKeyId}">
        </div>

        <div class="mb-3" id="aws_secret_container">
            <label class="form-label">AWS_SECRET_ACCESS_KEY</label>

            <div class="input-group">
                <!-- ‚úÖ oculto (puntos) -->
                <input id="awsSecretAccessKey"
                       type="password"
                       class="form-control"
                       placeholder="Secreto AWS"
                       th:value="${awsSecretAccessKey}">

                <!-- ‚úÖ solo copiar (sin mostrar en claro) -->
                <button type="button"
                        class="btn btn-outline-secondary"
                        id="btn_copiar_secret"
                        onclick="copiarSecretAws()">
                    Copiar
                </button>
            </div>

            <div class="form-text">
                Se guarda como secret. Se muestra oculto (‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢). Pulsa <b>Copiar</b> para copiarlo.
            </div>
        </div>

        <hr class="my-4">

        <!-- =========================
             ‚úÖ COMPROBACI√ìN IMAGEN ECR
             ========================= -->

        <h5 class="mb-3">Comprobaci√≥n de imagen</h5>

        <div class="mb-3" id="image_tag_container">
            <label class="form-label">IMAGE_TAG</label>
            <input id="imageTag"
                   class="form-control"
                   placeholder="Ej: latest"
                   th:value="${imageTag}">
            <div class="form-text">
                Tag de la imagen en ECR (por ejemplo: latest, v1.0.0).
            </div>
        </div>

        <button type="button"
                onclick="ejecutarPaso4()"
                class="btn btn-primary"
                id="btn_comprobar">
            Comprobar
        </button>

        <hr>

        <!-- ESTADO -->
        <p class="mt-3 fs-5">
            Estado:
            <span id="estado"
                  class="badge bg-secondary"
                  th:text="${controlPaso != null ? controlPaso.estado : 'PENDIENTE'}">
                PENDIENTE
            </span>
        </p>

        <p id="mensaje"
           class="text-muted mb-0"
           th:text="${controlPaso != null ? controlPaso.mensaje : ''}">
        </p>

        <!-- ‚úÖ BLOQUE "OK" con variables para copiar -->
        <div id="bloqueSecrets" class="mt-4 d-none">
            <hr>
            <h5 class="mb-2">Ahora crea en tu repositorio estas variables secretas:</h5>

            <div class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead>
                    <tr>
                        <th>Variable</th>
                        <th>Valor</th>
                        <th class="text-end">Acci√≥n</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td><code>ECR_REPOSITORY</code></td>
                        <td><code id="out_ecrRepository"></code></td>
                        <td class="text-end">
                            <button class="btn btn-outline-secondary btn-sm"
                                    type="button"
                                    onclick="copiarTexto('out_ecrRepository')">
                                Copiar
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td><code>AWS_REGION</code></td>
                        <td><code id="out_awsRegion"></code></td>
                        <td class="text-end">
                            <button class="btn btn-outline-secondary btn-sm"
                                    type="button"
                                    onclick="copiarTexto('out_awsRegion')">
                                Copiar
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td><code>AWS_ACCOUNT_ID</code></td>
                        <td><code id="out_awsAccountId"></code></td>
                        <td class="text-end">
                            <button class="btn btn-outline-secondary btn-sm"
                                    type="button"
                                    onclick="copiarTexto('out_awsAccountId')">
                                Copiar
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td><code>AWS_ACCESS_KEY_ID</code></td>
                        <td><code id="out_awsAccessKeyId"></code></td>
                        <td class="text-end">
                            <button class="btn btn-outline-secondary btn-sm"
                                    type="button"
                                    onclick="copiarTexto('out_awsAccessKeyId')">
                                Copiar
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td><code>AWS_SECRET_ACCESS_KEY</code></td>
                        <!-- ‚úÖ nunca mostramos el secreto en claro -->
                        <td><code>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</code></td>
                        <td class="text-end">
                            <button class="btn btn-outline-secondary btn-sm"
                                    type="button"
                                    onclick="copiarSecretAws()">
                                Copiar
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="form-text">
                Consejo: en GitHub ‚Üí <b>Settings</b> ‚Üí <b>Secrets and variables</b> ‚Üí <b>Actions</b> ‚Üí <b>New repository secret</b>.<br>
                en GitLab ‚Üí <b>Settings</b> ‚Üí <b>CI/CD</b> ‚Üí <b>Variables</b> ‚Üí <b>Add variable</b>.<br>
                en Jenkins ‚Üí <b>Manage Jenkins</b> ‚Üí <b>Credentials</b> ‚Üí <b>(Global / Folder)</b> ‚Üí <b>Add Credentials</b>.
            </div>
        </div>

    </div>

    <!-- ‚ö†Ô∏è AVISO BLOQUEO -->
    <div id="alertBloqueo"
         th:if="${!pasoActualCompleto}"
         class="alert alert-warning mt-3">
        Debes completar correctamente este paso antes de continuar al siguiente.
    </div>

    <!-- NAVEGACI√ìN (mismo dise√±o, fijos a los extremos) -->
    <div class="mt-4 mb-4 d-flex justify-content-between align-items-start flex-nowrap gap-3">

        <!-- Izquierda -->
        <a th:href="@{/wizard/paso3(appId=${appId})}"
           class="btn btn-outline-secondary">
            ‚Üê Volver al paso 3
        </a>

        <!-- Derecha -->
        <div class="text-end">
            <button id="btnPaso5"
                    class="btn btn-outline-secondary"
                    th:disabled="${!pasoActualCompleto}"
                    th:onclick="${pasoActualCompleto}
                        ? 'location.href=\'/wizard/paso5?appId=' + ${appId} + '\''
                        : null">
                Ir al paso 5 ‚Üí
            </button>

            <div id="msgBloqueo"
                 th:if="${!pasoActualCompleto}"
                 class="form-text text-danger mt-1">
                Completa este paso para poder continuar.
            </div>
        </div>

    </div>

</div>

<!-- ‚úÖ IntroJS -->
<script src="https://cdn.jsdelivr.net/npm/intro.js/minified/intro.min.js"></script>

<script>
    function getAppId() {
        const meta = document.querySelector('meta[name="appId"]');
        if (!meta) throw new Error("appId missing");
        return meta.getAttribute("content");
    }

    function setEstadoUI(estado, mensaje) {
        const badge = document.getElementById("estado");
        const msg = document.getElementById("mensaje");

        badge.textContent = estado || "N/A";
        msg.textContent = mensaje || "";

        badge.className =
            estado === "OK" ? "badge bg-success" :
                estado === "KO" ? "badge bg-danger" :
                    "badge bg-secondary";
    }

    function limpiarErroresCampos() {
        ["ecrRepository","awsRegion","awsAccountId","awsAccessKeyId","awsSecretAccessKey","imageTag"]
            .forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove("is-invalid");
            });
    }

    function marcarInvalidosSiVacios(payload) {
        let hayError = false;

        const campos = [
            { id: "ecrRepository", value: payload.ecrRepository },
            { id: "awsRegion", value: payload.awsRegion },
            { id: "awsAccountId", value: payload.awsAccountId },
            { id: "awsAccessKeyId", value: payload.awsAccessKeyId },
            { id: "awsSecretAccessKey", value: payload.awsSecretAccessKey },
            { id: "imageTag", value: payload.imageTag }
        ];

        for (const c of campos) {
            const el = document.getElementById(c.id);
            const v = (c.value || "").trim();
            if (!v) {
                hayError = true;
                if (el) el.classList.add("is-invalid");
            }
        }
        return hayError;
    }

    (function pintarEstadoInicial() {
        const badge = document.getElementById("estado");
        if (!badge) return;

        const estado = badge.textContent.trim();
        badge.className =
            estado === "OK" ? "badge bg-success" :
                estado === "KO" ? "badge bg-danger" :
                    "badge bg-secondary";
    })();

    function desbloquearPaso5(appId) {
        const btn = document.getElementById("btnPaso5");
        const msg = document.getElementById("msgBloqueo");
        const alert = document.getElementById("alertBloqueo");

        if (btn) {
            btn.disabled = false;
            btn.onclick = () =>
                window.location.href =
                    `/wizard/paso5?appId=${encodeURIComponent(appId)}`;
        }

        if (msg) msg.remove();
        if (alert) alert.remove();
    }

    function mostrarBloqueSecrets(payload) {
        document.getElementById("out_ecrRepository").textContent = payload.ecrRepository;
        document.getElementById("out_awsRegion").textContent = payload.awsRegion;
        document.getElementById("out_awsAccountId").textContent = payload.awsAccountId;
        document.getElementById("out_awsAccessKeyId").textContent = payload.awsAccessKeyId;

        const bloque = document.getElementById("bloqueSecrets");
        if (bloque) bloque.classList.remove("d-none");
    }

    function ocultarBloqueSecrets() {
        const bloque = document.getElementById("bloqueSecrets");
        if (bloque) bloque.classList.add("d-none");
    }

    async function copiarTexto(elementId) {
        const el = document.getElementById(elementId);
        const text = (el?.textContent || "").trim();
        if (!text) return;
        await navigator.clipboard.writeText(text);
    }

    async function copiarSecretAws() {
        const secret = (document.getElementById("awsSecretAccessKey")?.value || "").trim();
        if (!secret) return;
        await navigator.clipboard.writeText(secret);
    }

    // ‚úÖ confirma en backend que el paso est√° OK + guardar variables
    async function confirmarPaso4(appId, payload) {
        const headers = {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
        };

        const body =
            `appId=${encodeURIComponent(appId)}` +
            `&ecrRepository=${encodeURIComponent(payload.ecrRepository)}` +
            `&awsRegion=${encodeURIComponent(payload.awsRegion)}` +
            `&awsAccountId=${encodeURIComponent(payload.awsAccountId)}` +
            `&awsAccessKeyId=${encodeURIComponent(payload.awsAccessKeyId)}` +
            `&awsSecretAccessKey=${encodeURIComponent(payload.awsSecretAccessKey)}` +
            `&imageTag=${encodeURIComponent(payload.imageTag)}`;

        const res = await fetch("/wizard/paso4/confirmar", {
            method: "POST",
            headers,
            body
        });

        if (!res.ok) {
            throw new Error("Error confirmando paso4. HTTP " + res.status);
        }
    }

    async function ejecutarPaso4() {
        const appId = getAppId();

        const payload = {
            ecrRepository: (document.getElementById("ecrRepository")?.value || "").trim(),
            awsRegion: (document.getElementById("awsRegion")?.value || "").trim(),
            awsAccountId: (document.getElementById("awsAccountId")?.value || "").trim(),
            awsAccessKeyId: (document.getElementById("awsAccessKeyId")?.value || "").trim(),
            awsSecretAccessKey: (document.getElementById("awsSecretAccessKey")?.value || "").trim(),
            imageTag: (document.getElementById("imageTag")?.value || "").trim()
        };

        // limpiar errores previos + ocultar bloque secrets
        limpiarErroresCampos();
        ocultarBloqueSecrets();

        // ‚úÖ validar TODOS los campos (5 variables + tag)
        if (marcarInvalidosSiVacios(payload)) {
            setEstadoUI(
                "KO",
                "Debes completar TODOS los campos: ECR_REPOSITORY, AWS_REGION, AWS_ACCOUNT_ID, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY e IMAGE_TAG."
            );
            return;
        }

        try {
            setEstadoUI("PENDIENTE", "Ejecutando comprobaci√≥n...");

            // ‚úÖ tu API actual usa repositoryName + imageTag.
            // Para mantener compatibilidad, enviamos repositoryName = ecrRepository.
            const url = `/api/wizard/paso4?appId=${encodeURIComponent(appId)}`
                + `&repositoryName=${encodeURIComponent(payload.ecrRepository)}`
                + `&imageTag=${encodeURIComponent(payload.imageTag)}`;

            const res = await fetch(url);
            if (!res.ok) throw new Error("HTTP " + res.status);

            const data = await res.json();
            setEstadoUI(data.estado, data.mensaje);

            if (data.estado === "OK") {
                // 1) confirmo (persisto) variables en backend
                await confirmarPaso4(appId, payload);

                // 2) muestro bloque con variables para copiar
                mostrarBloqueSecrets(payload);

                // 3) desbloqueo paso 5
                desbloquearPaso5(appId);
            }

        } catch (e) {
            setEstadoUI("KO", "Error llamando al backend o confirmando el paso 4.");
        }
    }

    /* ======================================================
       ‚úÖ INTROJS (mismo patr√≥n que el ejemplo del profesor)
       ====================================================== */
    document.addEventListener('DOMContentLoaded', function () {
        let steps = [
            {
                title: "AWS + ECR",
                intro: `
            Bienvenido al <b>Paso 4</b> del asistente.<br><br>
            En este paso introducir√°s las <b>credenciales de AWS</b>
            y comprobar√°s que existe una <b>imagen Docker</b>
            en Amazon <b>ECR</b>.
        `
            },
            {
                element: "#btnGuiaPaso",
                title: "üìò Gu√≠a del paso (MUY IMPORTANTE)",
                intro: `
            Antes de continuar, descarga y lee la gu√≠a de este paso.<br><br>
            Explica c√≥mo obtener las credenciales de AWS,
            c√≥mo identificar tu repositorio ECR
            y los errores m√°s comunes.
        `,
                position: "bottom"
            },
            {
                element: "#ecr_repo_container",
                intro: `
            <b>ECR_REPOSITORY</b><br>
            Nombre del repositorio en Amazon ECR.<br>
            <u>No</u> incluyas la URL completa, solo el nombre.
        `
            },
            {
                element: "#aws_region_container",
                intro: `
            <b>AWS_REGION</b><br>
            Regi√≥n donde est√° tu repositorio ECR
            (por ejemplo <code>eu-west-1</code>).
        `
            },
            {
                element: "#aws_account_container",
                intro: `
            <b>AWS_ACCOUNT_ID</b><br>
            ID de tu cuenta AWS (12 d√≠gitos).
        `
            },
            {
                element: "#aws_access_container",
                intro: `
            <b>AWS_ACCESS_KEY_ID</b><br>
            Clave de acceso del usuario IAM.<br>
            Se guardar√° como <b>Secret</b>.
        `
            },
            {
                element: "#aws_secret_container",
                intro: `
            <b>AWS_SECRET_ACCESS_KEY</b><br>
            Clave secreta del usuario IAM.<br>
            Se muestra oculta y se guarda como <b>Secret</b>.
        `
            },
            {
                element: "#image_tag_container",
                intro: `
            <b>IMAGE_TAG</b><br>
            Tag de la imagen Docker a comprobar en ECR
            (<code>latest</code>, <code>v1.0.0</code>, etc.).
        `
            },
            {
                element: "#btn_comprobar",
                intro: `
            Pulsa aqu√≠ para comprobar que la imagen existe en ECR.<br>
            Si todo es correcto, el paso se marcar√° como <b>OK</b>
            y aparecer√°n las variables para copiarlas como <b>Secrets</b>.
        `
            },
            {
                element: "#btnPaso5",
                intro: `
            Cuando el estado est√© en <b>OK</b>,
            podr√°s continuar al <b>Paso 5</b> del asistente.
        `
            }
        ];

        const btn = document.getElementById('inicio_tutorial');
        if (!btn) return;

        btn.addEventListener('click', function () {
            introJs().setOptions({
                steps: steps,
                nextLabel: "Siguiente",
                prevLabel: "Anterior",
                doneLabel: "Terminar",
            }).start();
        });
    });
</script>

</body>
</html>