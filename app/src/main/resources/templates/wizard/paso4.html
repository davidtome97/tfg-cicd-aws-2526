<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Paso 4 – Comprobar imagen en ECR</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>

<body class="bg-light">

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Sistema CI/CD – Paso 4</a>
    </div>
</nav>

<div class="container">

    <h2 class="mb-3">Paso 4 – Comprobar imagen en ECR</h2>
    <a href="/manuales/paso4-AwsErc.pdf" target="_blank"
       class="btn btn-outline-secondary btn-sm">
        Ver guía de este paso
    </a>
    <p class="text-muted">
        Se comprueba que existe una imagen Docker en tu repositorio de Amazon ECR
        con el <strong>nombre</strong> y el <strong>tag</strong> indicados.
    </p>

    <div class="card p-4 shadow-sm">
        <div class="mb-3">
            <label class="form-label">Repositorio ECR</label>
            <input id="repositoryName" class="form-control"
                   placeholder="Ej: davidtome97/tfg-cicd-aws-2526"
                   value="davidtome97/tfg-cicd-aws-2526">
        </div>

        <div class="mb-3">
            <label class="form-label">Tag de la imagen</label>
            <input id="imageTag" class="form-control"
                   placeholder="Ej: latest"
                   value="latest">
        </div>

        <button onclick="ejecutarPaso4()" class="btn btn-primary">Comprobar</button>

        <hr>

        <p class="mt-3 fs-5">
            Estado: <span id="estado" class="badge bg-secondary">PENDIENTE</span>
        </p>
        <p id="mensaje" class="text-muted"></p>
    </div>

    <div class="mt-3 d-flex justify-content-between">
        <a href="/wizard/paso3" class="btn btn-link">&larr; Volver al paso 3</a>
        <a href="/wizard/paso5" class="btn btn-link">Ir al paso 5 &rarr;</a>
    </div>

</div>

<script>
    function ejecutarPaso4() {
        const repositoryName = document.getElementById("repositoryName").value;
        const imageTag = document.getElementById("imageTag").value;

        fetch(`/api/wizard/paso4?repositoryName=${encodeURIComponent(repositoryName)}&imageTag=${encodeURIComponent(imageTag)}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("estado").innerText = data.estado;
                document.getElementById("mensaje").innerText = data.mensaje;

                if (data.estado === "OK") {
                    document.getElementById("estado").className = "badge bg-success";
                } else {
                    document.getElementById("estado").className = "badge bg-danger";
                }

                // Guardar resultado del paso 4 en sessionStorage
                sessionStorage.setItem(
                    "wizard_paso4",
                    JSON.stringify({ estado: data.estado, mensaje: data.mensaje })
                );
            })
            .catch(err => {
                document.getElementById("estado").innerText = "KO";
                document.getElementById("estado").className = "badge bg-danger";
                document.getElementById("mensaje").innerText =
                    "Error llamando al backend en el paso 4.";

                // Guardar error en sessionStorage
                sessionStorage.setItem(
                    "wizard_paso4",
                    JSON.stringify({ estado: "KO", mensaje: "Error llamando al backend en el paso 4." })
                );
            });
    }
</script>

</body>
</html>