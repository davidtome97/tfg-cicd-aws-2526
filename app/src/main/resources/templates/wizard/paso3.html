<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Paso 3 ‚Äì Comprobar repositorio Git</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <!-- ‚úÖ IntroJS (tutorial guiado) -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/intro.js/minified/introjs.min.css">

    <meta name="appId" th:content="${appId}">
</head>

<body class="bg-light">

<div class="container mt-3">
    <div class="d-flex justify-content-end mb-3">
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn btn-outline-danger">
                Cerrar sesi√≥n
            </button>
        </form>
    </div>
</div>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/aplicaciones}">
            Sistema CI/CD ‚Äì Paso 3
        </a>
    </div>
</nav>

<div class="container" id="tutorial_root" style="margin-bottom: 70px;">

    <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="mb-0">Paso 3 ‚Äì Comprobar repositorio Git</h2>

        <div class="d-flex gap-2">
            <a id="btnGuiaPaso"
               href="/manuales/paso_3.pdf"
               target="_blank"
               class="btn btn-outline-secondary btn-sm">
                üìò Ver gu√≠a de este paso
            </a>

            <!-- ‚úÖ bot√≥n tutorial -->
            <button id="inicio_tutorial"
                    type="button"
                    class="btn btn-outline-secondary btn-sm">
                Iniciar tutorial
            </button>
        </div>
    </div>

    <p class="text-muted" id="intro_texto">
        Se verifica que el repositorio indicado existe en GitHub o GitLab
        y que contiene al menos un commit.
    </p>

    <div class="card p-4 shadow-sm" id="card_paso3">

        <div class="mb-3" id="proveedor_container">
            <label class="form-label">Proveedor</label>

            <!-- ‚úÖ Precargado desde BD -->
            <select id="proveedor" class="form-select">
                <option value="github" th:selected="${proveedor == 'github'}">GitHub</option>
                <option value="gitlab" th:selected="${proveedor == 'gitlab'}">GitLab</option>
            </select>
        </div>

        <div class="mb-3" id="repo_container">
            <label class="form-label">Repositorio</label>

            <!-- ‚úÖ Precargado desde BD -->
            <input id="repoInput"
                   class="form-control"
                   name="repo"
                   th:value="${repoSugerido}"
                   placeholder="Ej: usuario/repositorio"
                   autocomplete="off"
                   required>

            <div class="form-text">
                Formato: <code>owner/repo</code> (GitHub) o
                <code>grupo/proyecto</code> (GitLab).
            </div>
        </div>

        <button type="button"
                onclick="ejecutarPaso3()"
                class="btn btn-primary"
                id="btn_comprobar">
            Comprobar
        </button>

        <hr>

        <!-- ESTADO -->
        <p class="mt-3 fs-5">
            Estado:
            <span id="estado"
                  class="badge bg-secondary"
                  th:text="${controlPaso != null ? controlPaso.estado : 'PENDIENTE'}">
                PENDIENTE
            </span>
        </p>

        <p id="mensaje"
           class="text-muted mb-0"
           th:text="${controlPaso != null ? controlPaso.mensaje : ''}">
        </p>
    </div>

    <!-- ‚ö†Ô∏è AVISO BLOQUEO -->
    <div id="alertBloqueo"
         th:if="${!pasoActualCompleto}"
         class="alert alert-warning mt-3">
        Debes completar correctamente este paso antes de continuar al siguiente.
    </div>

    <!-- NAVEGACI√ìN (mismo dise√±o, fijos a los extremos) -->
    <div class="mt-4 mb-4 d-flex justify-content-between align-items-start flex-nowrap gap-3">

        <!-- Izquierda -->
        <a th:href="@{/wizard/paso2(appId=${appId})}"
           class="btn btn-outline-secondary">
            ‚Üê Volver al paso 2
        </a>

        <!-- Derecha -->
        <div class="text-end">
            <button id="btnPaso4"
                    class="btn btn-outline-secondary"
                    th:disabled="${!pasoActualCompleto}"
                    th:onclick="${pasoActualCompleto}
                        ? 'location.href=\'/wizard/paso4?appId=' + ${appId} + '\''
                        : null">
                Ir al paso 4 ‚Üí
            </button>

            <div id="msgBloqueo"
                 th:if="${!pasoActualCompleto}"
                 class="form-text text-danger mt-1">
                Completa este paso para poder continuar.
            </div>
        </div>

    </div>

</div>

<!-- ‚úÖ IntroJS -->
<script src="https://cdn.jsdelivr.net/npm/intro.js/minified/intro.min.js"></script>

<script>
    function getAppId() {
        const meta = document.querySelector('meta[name="appId"]');
        if (!meta) throw new Error("appId missing");
        return meta.getAttribute("content");
    }

    function setEstadoUI(estado, mensaje) {
        const badge = document.getElementById("estado");
        const msg = document.getElementById("mensaje");

        badge.textContent = estado || "N/A";
        msg.textContent = mensaje || "";

        badge.className =
            estado === "OK" ? "badge bg-success" :
                estado === "KO" ? "badge bg-danger" :
                    "badge bg-secondary";
    }

    function limpiarErroresCampos() {
        const repo = document.getElementById("repoInput");
        const prov = document.getElementById("proveedor");
        if (repo) repo.classList.remove("is-invalid");
        if (prov) prov.classList.remove("is-invalid");
    }

    function validarCampos(proveedor, repo) {
        let ok = true;

        const repoEl = document.getElementById("repoInput");
        const provEl = document.getElementById("proveedor");

        if (!proveedor.trim()) {
            ok = false;
            if (provEl) provEl.classList.add("is-invalid");
        }

        if (!repo.trim()) {
            ok = false;
            if (repoEl) repoEl.classList.add("is-invalid");
        } else {
            if (!repo.includes("/") || repo.split("/").length < 2) {
                ok = false;
                if (repoEl) repoEl.classList.add("is-invalid");
                setEstadoUI("KO", "Formato inv√°lido. Usa owner/repo (GitHub) o grupo/proyecto (GitLab).");
                return false;
            }
        }

        if (!ok) {
            setEstadoUI("KO", "Debes completar Proveedor y Repositorio para comprobar.");
        }
        return ok;
    }

    (function pintarEstadoInicial() {
        const badge = document.getElementById("estado");
        if (!badge) return;

        const estado = badge.textContent.trim();
        badge.className =
            estado === "OK" ? "badge bg-success" :
                estado === "KO" ? "badge bg-danger" :
                    "badge bg-secondary";
    })();

    function desbloquearPaso4(appId) {
        const btn = document.getElementById("btnPaso4");
        const msg = document.getElementById("msgBloqueo");
        const alert = document.getElementById("alertBloqueo");

        if (btn) {
            btn.disabled = false;
            btn.onclick = () =>
                window.location.href =
                    `/wizard/paso4?appId=${encodeURIComponent(appId)}`;
        }

        if (msg) msg.remove();
        if (alert) alert.remove();
    }

    // ‚úÖ (recomendado) confirma en backend que el paso est√° OK y guarda proveedor/repo si quieres
    async function confirmarPaso3(appId, proveedor, repo) {
        const headers = {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
        };

        const body =
            `appId=${encodeURIComponent(appId)}` +
            `&proveedor=${encodeURIComponent(proveedor)}` +
            `&repo=${encodeURIComponent(repo)}`;

        const res = await fetch("/wizard/paso3/confirmar", {
            method: "POST",
            headers,
            body
        });

        // Si a√∫n no has creado el endpoint, esto fallar√°.
        // En ese caso comenta la llamada a confirmarPaso3(...) en ejecutarPaso3().
        if (!res.ok) {
            throw new Error("Error confirmando paso3. HTTP " + res.status);
        }
    }

    async function ejecutarPaso3() {
        const appId = getAppId();
        const proveedor = (document.getElementById("proveedor")?.value || "").trim();
        const repo = (document.getElementById("repoInput")?.value || "").trim();

        limpiarErroresCampos();

        if (!validarCampos(proveedor, repo)) return;

        try {
            setEstadoUI("PENDIENTE", "Ejecutando comprobaci√≥n...");

            const url = `/api/wizard/paso3?appId=${encodeURIComponent(appId)}`
                + `&proveedor=${encodeURIComponent(proveedor)}`
                + `&repo=${encodeURIComponent(repo)}`;

            const res = await fetch(url);
            if (!res.ok) throw new Error("HTTP " + res.status);

            const data = await res.json();
            setEstadoUI(data.estado, data.mensaje);

            if (data.estado === "OK") {
                await confirmarPaso3(appId, proveedor, repo);
                desbloquearPaso4(appId);
            }

        } catch (e) {
            setEstadoUI("KO", "Error llamando al backend o confirmando el paso 3.");
        }
    }

    /* ======================================================
       ‚úÖ INTROJS (mismo patr√≥n que el ejemplo del profesor)
       ====================================================== */
    document.addEventListener('DOMContentLoaded', function () {
        let steps = [
            {
                title: "REPOSITORIO GIT",
                intro: `
            Bienvenido al <b>Paso 3</b> del asistente.<br><br>
            En este paso comprobar√°s que tu repositorio existe
            (<b>GitHub</b> o <b>GitLab</b>) y que contiene al menos
            <b>un commit</b> v√°lido.
        `
            },
            {
                element: "#btnGuiaPaso",
                title: "üìò Gu√≠a del paso (MUY IMPORTANTE)",
                intro: `
            Antes de continuar, descarga y lee la gu√≠a de este paso.<br><br>
            Explica el formato correcto del repositorio y
            c√≥mo evitar los errores m√°s comunes.
        `,
                position: "bottom"
            },
            {
                element: "#proveedor_container",
                intro: `
            Selecciona el <b>proveedor</b> donde est√° tu repositorio:
            GitHub o GitLab.
        `
            },
            {
                element: "#repo_container",
                intro: `
            Escribe el repositorio con el formato correcto:<br>
            <code>owner/repo</code> (GitHub) o
            <code>grupo/proyecto</code> (GitLab).
        `
            },
            {
                element: "#btn_comprobar",
                intro: `
            Pulsa aqu√≠ para comprobar el repositorio.<br>
            Si todo es correcto, el paso se marcar√° como <b>OK</b>
            y se desbloquear√° el siguiente paso.
        `
            },
            {
                element: "#btnPaso4",
                intro: `
            Cuando el estado est√© en <b>OK</b>,
            podr√°s continuar al <b>Paso 4</b> del asistente.
        `
            }
        ];

        const btn = document.getElementById('inicio_tutorial');
        if (!btn) return;

        btn.addEventListener('click', function () {
            this.style.animation = "none";
            introJs().setOptions({
                steps: steps,
                nextLabel: "Siguiente",
                prevLabel: "Anterior",
                doneLabel: "Terminar",
            }).start();
        });
    });
</script>

</body>
</html>