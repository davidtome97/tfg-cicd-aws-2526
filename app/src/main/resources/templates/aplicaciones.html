<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Listado de aplicaciones | SistemaGestionApp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        body {
            min-height: 100vh;
            background:
                    radial-gradient(1000px 600px at 10% 10%, rgba(13,110,253,.12), transparent 60%),
                    radial-gradient(900px 500px at 90% 20%, rgba(25,135,84,.10), transparent 55%),
                    radial-gradient(900px 600px at 50% 100%, rgba(111,66,193,.08), transparent 55%),
                    #f8fafc;
        }

        .page-wrap { padding: 28px 0; }

        /* Contenedor ‚Äúajustado‚Äù */
        .container-fit {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 18px;
        }

        .shell {
            border: 1px solid rgba(15, 23, 42, .08);
            border-radius: 20px;
            background: rgba(255,255,255,.9);
            box-shadow: 0 18px 50px rgba(2, 6, 23, .10);
        }

        .topbar {
            padding: 20px 28px;
            border-bottom: 1px solid rgba(15, 23, 42, .08);
        }

        .title {
            font-weight: 800;
            letter-spacing: -.02em;
            margin: 0;
        }

        .muted { color: rgba(15, 23, 42, .65); }

        .btn {
            border-radius: 12px;
            font-weight: 600;
        }

        /* TABLA */
        .table {
            font-size: .95rem;
            margin-bottom: 0;
        }

        .table thead th {
            background: #0f172a;
            color: #fff;
            padding: .9rem;
            white-space: nowrap;
        }

        .table td {
            padding: .85rem;
            vertical-align: middle;
        }

        /* Evita que se partan cosas raras */
        .nowrap { white-space: nowrap; }

        /* Estado */
        .pill {
            display: inline-flex;
            align-items: center;
            gap: .45rem;
            padding: .3rem .6rem;
            border-radius: 999px;
            font-size: .8rem;
            font-weight: 700;
            background: #f8fafc;
            border: 1px solid rgba(15,23,42,.15);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #94a3b8;
        }
        .dot-ok { background: #16a34a; }
        .dot-warn { background: #f59e0b; }

        /* Progreso */
        .progress {
            height: 10px;
            border-radius: 999px;
            background: rgba(15,23,42,.08);
        }
        .progress-bar { border-radius: 999px; }

        .table-card { padding: 18px 22px; }

        /* ACCIONES en 3 filas (2+2+1) */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(110px, 1fr));
            gap: .45rem;
            align-items: stretch;
        }

        .actions-grid .btn {
            padding: .5rem .6rem;
            font-size: .82rem;
            white-space: nowrap;
        }

        .actions-grid .danger {
            grid-column: 1 / -1;
        }

        .btn-soft {
            background: #f8fafc;
            border: 1px solid rgba(15,23,42,.18);
            color: #0f172a;
        }
        .btn-soft:hover { background: #eef2f7; }

        /* ‚úÖ Ajuste consistente de anchos */
        th.col-nombre { width: 180px; }
        th.col-lang   { width: 110px; }
        th.col-bd     { width: 140px; }
        th.col-ci     { width: 150px; }
        th.col-fecha  { width: 160px; }
        th.col-prog   { width: 160px; }
        th.col-estado { width: 120px; }
        th.col-actions{ width: 260px; } /* como en tu captura */
    </style>
</head>

<body>
<div class="page-wrap">
    <div class="container-fit">
        <div class="shell">

            <div class="topbar d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1 class="h5 title mb-1">Listado de aplicaciones</h1>
                    <div class="muted small">Gestiona tus apps y accede al asistente de despliegue paso a paso.</div>
                </div>

                <div class="d-flex gap-2">
                    <a th:href="@{/ayuda}" class="btn btn-outline-secondary btn-sm">Ayuda / Manuales</a>
                    <a th:href="@{/aplicaciones/nueva}" class="btn btn-success btn-sm">+ Nueva aplicaci√≥n</a>
                    <form th:action="@{/logout}" method="post" class="m-0">
                        <button class="btn btn-outline-danger btn-sm">Cerrar sesi√≥n</button>
                    </form>
                </div>
            </div>

            <div class="table-card">

                <!-- Estado vac√≠o -->
                <div th:if="${#lists.isEmpty(aplicaciones)}" class="text-center py-5">
                    <div class="fw-bold mb-1">Todav√≠a no tienes aplicaciones configuradas</div>
                    <div class="muted mb-3">Crea una nueva aplicaci√≥n y genera el pipeline CI/CD autom√°ticamente.</div>
                    <a th:href="@{/aplicaciones/nueva}" class="btn btn-success">Crear primera aplicaci√≥n</a>
                </div>

                <!-- Tabla -->
                <table th:if="${!#lists.isEmpty(aplicaciones)}"
                       class="table table-hover table-bordered align-middle">
                    <thead>
                    <tr>
                        <th class="col-nombre">Nombre</th>
                        <th class="col-lang">Lenguaje</th>
                        <th class="col-bd">Base de datos</th>
                        <th class="col-ci">Proveedor CI/CD</th>
                        <th class="col-fecha">Fecha creaci√≥n</th>
                        <th class="col-prog">Progreso</th>
                        <th class="col-estado">Estado</th>
                        <th class="col-actions">Acciones</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="app : ${aplicaciones}">
                        <td class="fw-semibold" th:text="${app.nombre}">Nombre</td>

                        <td class="nowrap">
                            <span class="badge bg-light text-dark border" th:text="${app.lenguaje}">JAVA</span>
                        </td>

                        <td class="nowrap">
                            <span class="badge bg-light text-dark border" th:text="${app.tipoBaseDatos}">POSTGRESQL</span>
                        </td>

                        <td class="nowrap">
                            <span class="badge bg-light text-dark border" th:text="${app.proveedorCiCd}">GITHUB</span>
                        </td>

                        <td class="small muted"
                            th:text="${app.fechaCreacion != null ? #temporals.format(app.fechaCreacion,'dd/MM/yyyy HH:mm') : '--'}">
                            --
                        </td>

                        <!-- Progreso con fallback y % seguro -->
                        <td th:with="p=${progresoPorApp[app.id]},
                                     ok=${p != null ? p.ok : 0},
                                     tot=${p != null ? p.total : totalPasos},
                                     pct=${tot > 0 ? (ok * 100) / tot : 0}">
                            <div class="small fw-semibold mb-1" th:text="${ok + ' / ' + tot}">0 / 7</div>
                            <div class="progress">
                                <div class="progress-bar bg-success" th:style="'width:' + ${pct} + '%'"></div>
                            </div>
                        </td>

                        <!-- Estado con fallback -->
                        <td th:with="st=${estadoPorApp[app.id] != null ? estadoPorApp[app.id] : '--'}">
                            <span class="pill">
                                <span class="dot"
                                      th:classappend="${st=='OK'} ? ' dot-ok' : (${st=='PENDIENTE'} ? ' dot-warn' : '')"></span>
                                <span th:text="${st}">--</span>
                            </span>
                        </td>

                        <td>
                            <div class="actions-grid">
                                <a th:href="@{/wizard/paso0(appId=${app.id})}" class="btn btn-primary btn-sm">Asistente üß≠</a>
                                <a th:href="@{/aplicaciones/{id}/variables(id=${app.id})}" class="btn btn-soft btn-sm">Variables üìÑ</a>

                                <a th:href="@{/aplicaciones/{id}/zip(id=${app.id})}" class="btn btn-soft btn-sm">ZIP ‚¨áÔ∏è</a>
                                <a th:href="@{/aplicaciones/editar/{id}(id=${app.id})}" class="btn btn-soft btn-sm">Editar ‚úèÔ∏è</a>

                                <a th:href="@{/aplicaciones/eliminar/{id}(id=${app.id})}"
                                   class="btn btn-outline-danger btn-sm danger"
                                   onclick="return confirm('¬øSeguro que quieres eliminar esta aplicaci√≥n?');">
                                    Eliminar üóëÔ∏è
                                </a>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <div class="text-center mt-3 muted small">
                    ¬© 2026 ¬∑ SistemaGestionApp
                </div>

            </div>
        </div>
    </div>
</div>
</body>
</html>