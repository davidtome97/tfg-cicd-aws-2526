name: CI-{{ config.project_name }}

on:
  push:
    branches:
{% for b in config.branches %}
      - "{{ b }}"
{% endfor %}
{% if config.deploy_mode == 'tag' %}
    tags:
      - "*"
{% endif %}
{% if config.run_on_pr %}
  pull_request:
    branches:
{% for b in config.branches %}
      - "{{ b }}"
{% endfor %}
{% endif %}
{% if config.deploy_mode == 'manual' %}
  workflow_dispatch:
{% endif %}

jobs:

  # ======================================================
  # BUILD & TEST
  # ======================================================
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build & Test
        run: |
          ./mvnw -B -f pom.xml test

  # ======================================================
  # SONAR (opcional)
  # ======================================================
{% if config.use_sonar %}
  sonar:
    runs-on: ubuntu-latest
    needs: build_and_test
{% if not config.fail_on_sonar %}
    continue-on-error: true
{% endif %}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: SonarCloud Analysis
        env:
          SONAR_TOKEN: {{ '${{ secrets.SONAR_TOKEN }}' }}
{% if config.sonar.host %}
          SONAR_HOST_URL: "{{ config.sonar.host }}"
{% endif %}
        run: |
          ./mvnw -B verify sonar:sonar \
          {% if config.sonar.project_key %}-Dsonar.projectKey={{ config.sonar.project_key }} {% endif %} \
          {% if config.sonar.organization %}-Dsonar.organization={{ config.sonar.organization }} {% endif %} \
          {% if config.sonar.host %}-Dsonar.host.url={{ config.sonar.host }}{% endif %}
{% endif %}

  # ======================================================
  # DEPLOY AWS (opcional) - Build + push a ECR
  # ======================================================
{% if config.use_aws %}
  deploy:
    runs-on: ubuntu-latest
    needs:
      - build_and_test
{% if config.use_sonar %}
      - sonar
{% endif %}
{% if config.deploy_mode == 'main' %}
    # Opción 1) En cada push a main
    if: github.ref == 'refs/heads/main'
{% elif config.deploy_mode == 'tag' %}
    # Opción 2) Solo cuando haya un tag (release)
    if: startsWith(github.ref, 'refs/tags/')
{% elif config.deploy_mode == 'manual' %}
    # Opción 3) Solo manual (desde la UI de Actions)
    if: github.event_name == 'workflow_dispatch'
{% endif %}

    steps:
      - uses: actions/checkout@v4

      - name: Configurar credenciales de AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: {{ '${{ secrets.' ~ config.aws_secrets.access_key ~ ' }}' }}
          aws-secret-access-key: {{ '${{ secrets.' ~ config.aws_secrets.secret_key ~ ' }}' }}
          aws-region: {{ '${{ secrets.' ~ config.aws_secrets.region ~ ' }}' }}

      - name: Login en Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build y push de imagen Docker a ECR
        env:
          ECR_REGISTRY: {{ '${{ steps.ecr.outputs.registry }}' }}
          ECR_REPOSITORY: {{ '${{ github.repository }}' }}
          IMAGE_TAG: {{ '${{ github.sha }}' }}
        run: |
          IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "Construyendo imagen: $IMAGE_URI"
          docker build -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"
          echo "Imagen publicada en ECR -> $IMAGE_URI"
{% endif %}