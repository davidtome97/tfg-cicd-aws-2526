name: CI-{{ config.project_name }}

on:
  push:
    branches:
{% for b in config.branches %}
      - "{{ b }}"
{% endfor %}
    tags:
      - "*"

{% if config.run_on_pr %}
  pull_request:
    branches:
{% for b in config.branches %}
      - "{{ b }}"
{% endfor %}
{% endif %}

jobs:

  # ======================================================
  # BUILD & TEST (Java / Maven)
  # ======================================================
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build & Test
        run: |
          ./mvnw -B -f pom.xml test

  # ======================================================
  # SONAR (solo si config.use_sonar == True)
  # ======================================================
{% if config.use_sonar %}
  sonar:
    runs-on: ubuntu-latest
    needs: build_and_test
{% if not config.fail_on_sonar %}
    continue-on-error: true
{% endif %}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: SonarCloud Analysis
        env:
          SONAR_TOKEN: {% raw %}${{ secrets.SONAR_TOKEN }}{% endraw %}
          SONAR_HOST_URL: "{{ config.sonar.host or 'https://sonarcloud.io' }}"
        run: |
          ./mvnw -B verify sonar:sonar \
          -Dsonar.projectKey={{ config.sonar.project_key or 'davidtome97_tfg-cicd-aws-2526' }} \
          -Dsonar.organization={{ config.sonar.organization or 'davidtome97' }} \
          -Dsonar.host.url={{ config.sonar.host or 'https://sonarcloud.io' }}
{% endif %}

  # ======================================================
  # DEPLOY AWS — Build + push a ECR
  # ======================================================
{% if config.use_aws %}
  deploy:
    runs-on: ubuntu-latest
    needs:
      - build_and_test
{% if config.use_sonar %}
      - sonar
{% endif %}

    # Cuándo hacer deploy: según deploy_mode
{% if config.deploy_mode == 'tag' %}
    if: startsWith(github.ref, 'refs/tags/')
{% elif config.deploy_mode == 'main' %}
    if: github.ref == 'refs/heads/main'
{% elif config.deploy_mode == 'manual' %}
    if: github.event_name == 'workflow_dispatch'
{% endif %}

    steps:
      - uses: actions/checkout@v4

      - name: Configurar credenciales de AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: {% raw %}${{ secrets.AWS_ACCESS_KEY_ID }}{% endraw %}
          aws-secret-access-key: {% raw %}${{ secrets.AWS_SECRET_ACCESS_KEY }}{% endraw %}
          aws-region: {% raw %}${{ secrets.AWS_REGION }}{% endraw %}

      - name: Login en Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build y push de imagen Docker a ECR
        env:
          ECR_REGISTRY: {% raw %}${{ secrets.AWS_ECR_URL }}{% endraw %}
          ECR_REPOSITORY: {% raw %}${{ secrets.ECR_REPOSITORY }}{% endraw %}
          IMAGE_TAG: {% raw %}${{ github.sha }}{% endraw %}
        run: |
          IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "Construyendo imagen: $IMAGE_URI"

          # build con el SHA
          docker build -t "$IMAGE_URI" .

          # también tagueo :latest (como en GitLab)
          docker tag "$IMAGE_URI" "$ECR_REGISTRY/$ECR_REPOSITORY:latest"

          # push de ambas tags
          docker push "$IMAGE_URI"
          docker push "$ECR_REGISTRY/$ECR_REPOSITORY:latest"

          echo "Imágenes publicadas en ECR -> $IMAGE_URI y $ECR_REGISTRY/$ECR_REPOSITORY:latest"

  # ======================================================
  # DEPLOY EN EC2
  # ======================================================
  deploy_ec2:
    runs-on: ubuntu-latest
    needs:
      - deploy

    # Mismo disparador que el deploy a ECR
{% if config.deploy_mode == 'tag' %}
    if: startsWith(github.ref, 'refs/tags/')
{% elif config.deploy_mode == 'main' %}
    if: github.ref == 'refs/heads/main'
{% elif config.deploy_mode == 'manual' %}
    if: github.event_name == 'workflow_dispatch'
{% endif %}

    env:
      AWS_ACCESS_KEY_ID: {% raw %}${{ secrets.AWS_ACCESS_KEY_ID }}{% endraw %}
      AWS_SECRET_ACCESS_KEY: {% raw %}${{ secrets.AWS_SECRET_ACCESS_KEY }}{% endraw %}
      AWS_REGION: {% raw %}${{ secrets.AWS_REGION }}{% endraw %}
      AWS_ECR_URL: {% raw %}${{ secrets.AWS_ECR_URL }}{% endraw %}
      ECR_REPOSITORY: {% raw %}${{ secrets.ECR_REPOSITORY }}{% endraw %}
      EC2_HOST: {% raw %}${{ secrets.EC2_HOST }}{% endraw %}
      EC2_USER: {% raw %}${{ secrets.EC2_USUARIO }}{% endraw %}
      EC2_LLAVE_SSH: {% raw %}${{ secrets.EC2_LLAVE_SSH }}{% endraw %}
      EC2_KNOWN_HOSTS: {% raw %}${{ secrets.EC2_KNOWN_HOSTS }}{% endraw %}

    steps:
      - uses: actions/checkout@v4

      - name: Preparar clave SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s" "${EC2_LLAVE_SSH}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          if [ -n "${EC2_KNOWN_HOSTS}" ]; then
            printf "%s\n" "${EC2_KNOWN_HOSTS}" > ~/.ssh/known_hosts
          else
            ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts
          fi

      - name: Crear carpeta app en EC2
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes "$EC2_USER@$EC2_HOST" "mkdir -p ~/app"

      - name: Copiar docker-compose.yml a EC2
        run: |
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes docker-compose.yml "$EC2_USER@$EC2_HOST:~/app/docker-compose.yml"

      - name: Desplegar en EC2 (Docker Compose + ECR)
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes "$EC2_USER@$EC2_HOST" "
            set -e

            export AWS_ACCESS_KEY_ID='${AWS_ACCESS_KEY_ID}'
            export AWS_SECRET_ACCESS_KEY='${AWS_SECRET_ACCESS_KEY}'
            export AWS_REGION='${AWS_REGION}'
            export AWS_ECR_URL='${AWS_ECR_URL}'
            export ECR_REPOSITORY='${ECR_REPOSITORY}'

            REGISTRY_NO_PROTO=\"\${AWS_ECR_URL#https://}\"
            REGISTRY_HOST=\"\${REGISTRY_NO_PROTO%/}\"
            export IMAGE_URI=\"\${REGISTRY_HOST}/\${ECR_REPOSITORY}:latest\"

            echo 'Login en ECR'
            aws ecr get-login-password --region \"${AWS_REGION}\" \
              | docker login --username AWS --password-stdin \"\${REGISTRY_HOST}\"

            cd ~/app
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f
          "
{% endif %}